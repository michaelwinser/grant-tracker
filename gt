#!/bin/bash
set -e

IMAGE_NAME="grant-tracker"
CONTAINER_NAME="grant-tracker"
DEV_IMAGE_NAME="grant-tracker-dev"

usage() {
    echo "Usage: ./gt <command>"
    echo ""
    echo "Commands:"
    echo "  build       Build the production container"
    echo "  start       Start the app locally (port 8080)"
    echo "  stop        Stop the running container"
    echo "  logs        Show container logs"
    echo "  status      Show container status"
    echo ""
    echo "  dev         Start Vite dev server with hot reload (port 5174)"
    echo "  dev-build   Rebuild the dev container"
    echo "  run <cmd>   Run a command in the dev container"
    echo ""
    echo "  commit <msg> [files...]  Git commit with Co-Authored-By trailer"
    echo ""
    echo "  gcp auth              Authenticate with Google Cloud"
    echo "  gcp deploy <env>      Deploy to Cloud Run (staging|prod)"
    echo "  gcp domain <env> <d>  Map custom domain to environment"
    echo ""
    echo "Examples:"
    echo "  ./gt build && ./gt start           # Local testing"
    echo "  ./gt run npm run build             # Build frontend in container"
    echo "  ./gt run npm install               # Install dependencies"
    echo "  ./gt gcp deploy staging            # Deploy to staging"
    echo "  ./gt gcp deploy prod               # Deploy to production"
    echo "  ./gt gcp domain staging grants-staging.example.com"
}

# Build production container
build() {
    echo "Building production container..."
    docker build -t "$IMAGE_NAME" -f Dockerfile .
    echo "Build complete. Run './gt start' to start the app."
}

# Start production container locally
start() {
    if docker ps -q -f name="$CONTAINER_NAME" | grep -q .; then
        echo "Container already running. Use './gt stop' first or './gt logs' to see output."
        exit 1
    fi

    # Check if image exists
    if ! docker image inspect "$IMAGE_NAME" >/dev/null 2>&1; then
        echo "Image not found. Building first..."
        build
    fi

    # Remove stopped container if exists
    docker rm -f "$CONTAINER_NAME" 2>/dev/null || true

    # Load environment from local.env (preferred) or .env (fallback)
    local env_file=""
    if [ -f scripts/envs/local.env ]; then
        env_file="--env-file scripts/envs/local.env"
    elif [ -f .env ]; then
        env_file="--env-file .env"
    else
        echo "Warning: No environment file found."
        echo "Create scripts/envs/local.env from scripts/envs/local.env.example"
    fi

    local port="${PORT:-9800}"
    echo "Starting app on http://localhost:$port"
    docker run --rm -d \
        --name "$CONTAINER_NAME" \
        -p "$port:8080" \
        -e "PORT=8080" \
        $env_file \
        "$IMAGE_NAME"

    echo "Container started. Use './gt logs' to see output."
}

stop() {
    if docker ps -q -f name="$CONTAINER_NAME" | grep -q .; then
        echo "Stopping container..."
        docker stop "$CONTAINER_NAME"
    else
        echo "Container not running."
    fi
}

logs() {
    if docker ps -q -f name="$CONTAINER_NAME" | grep -q .; then
        docker logs -f "$CONTAINER_NAME"
    else
        echo "Container not running."
    fi
}

status() {
    if docker ps -q -f name="$CONTAINER_NAME" | grep -q .; then
        echo "Container is running"
        docker ps -f name="$CONTAINER_NAME" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
    else
        echo "Container is not running"
    fi
}

# Dev mode: Vite hot reload (for frontend development)
dev() {
    local dev_container="grant-tracker-dev-server"

    if docker ps -q -f name="$dev_container" | grep -q .; then
        echo "Dev container already running. Use 'docker stop $dev_container' first."
        exit 1
    fi

    # Check if dev image exists
    if ! docker image inspect "$DEV_IMAGE_NAME" >/dev/null 2>&1; then
        echo "Dev image not found. Building first..."
        dev_build
    fi

    docker rm -f "$dev_container" 2>/dev/null || true

    echo "Starting Vite dev server on http://localhost:5174"
    local tty_flags=""
    if [ -t 0 ]; then
        tty_flags="-it"
    fi
    docker run --rm $tty_flags \
        --name "$dev_container" \
        -p 5174:5174 \
        -v "$(pwd)":/workspace \
        "$DEV_IMAGE_NAME"
}

dev_build() {
    echo "Building dev container..."
    docker build -t "$DEV_IMAGE_NAME" -f .devcontainer/Dockerfile .
}

# Run a command in the dev container
run_cmd() {
    if [ $# -eq 0 ]; then
        echo "Usage: ./gt run <command>"
        echo ""
        echo "Examples:"
        echo "  ./gt run npm run build"
        echo "  ./gt run npm install"
        echo "  ./gt run go build ./..."
        exit 1
    fi

    # Check if dev image exists
    if ! docker image inspect "$DEV_IMAGE_NAME" >/dev/null 2>&1; then
        echo "Dev image not found. Building first..."
        dev_build
    fi

    local tty_flags=""
    if [ -t 0 ]; then
        tty_flags="-it"
    fi

    docker run --rm $tty_flags \
        -v "$(pwd)":/workspace \
        -w /workspace \
        "$DEV_IMAGE_NAME" \
        "$@"
}

# Git commit with automatic Co-Authored-By trailer
commit() {
    if [ $# -eq 0 ]; then
        echo "Error: No commit message specified"
        echo "Usage: ./gt commit \"message\" [files...]"
        exit 1
    fi

    local message="$1"
    shift

    # If additional args provided, stage those files
    if [ $# -gt 0 ]; then
        git add "$@"
    fi

    # Check if there are staged changes
    if ! git diff --cached --quiet; then
        git commit -m "$message" -m "Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
    else
        echo "No staged changes to commit."
        echo "Either stage files first with 'git add' or specify files: ./gt commit \"message\" file1 file2"
        exit 1
    fi
}

gcp() {
    local subcmd="${1:-}"
    case "$subcmd" in
        setup)
            gcp_run /workspace/scripts/gcp-setup.sh
            ;;
        oauth)
            gcp_run /workspace/scripts/gcp-oauth.sh
            ;;
        auth)
            shift
            gcp_auth "$@"
            ;;
        deploy)
            shift
            gcp_deploy "$@"
            ;;
        domain)
            shift
            gcp_domain "$@"
            ;;
        service-account)
            shift
            gcp_service_account "$@"
            ;;
        "")
            echo "Usage: ./gt gcp <subcommand>"
            echo ""
            echo "Subcommands:"
            echo "  auth                    Authenticate with Google Cloud"
            echo "  service-account         Create service account and download key"
            echo "  deploy <env>            Deploy to Cloud Run (staging|prod)"
            echo "  domain <env> <domain>   Map a custom domain to environment"
            echo ""
            echo "Examples:"
            echo "  ./gt gcp auth"
            echo "  ./gt gcp service-account"
            echo "  ./gt gcp deploy staging"
            echo "  ./gt gcp deploy prod"
            echo "  ./gt gcp domain staging grants-staging.example.com"
            ;;
        *)
            echo "Unknown gcp subcommand: $subcmd"
            exit 1
            ;;
    esac
}

gcp_auth() {
    if [ ! -t 0 ]; then
        echo "GCP authentication requires an interactive terminal."
        echo "Please run this command directly in your terminal:"
        echo ""
        echo "  ./gt gcp auth"
        exit 1
    fi

    mkdir -p "$(pwd)/.gcloud"

    docker run --rm -it \
        -v "$(pwd)":/workspace \
        -v "$(pwd)/.gcloud":/root/.config/gcloud \
        -w /workspace \
        "$DEV_IMAGE_NAME" \
        gcloud auth login --no-launch-browser
}

gcp_service_account() {
    if [ ! -t 0 ]; then
        echo "This command requires an interactive terminal."
        echo "Please run: ./gt gcp service-account"
        exit 1
    fi

    # Check if dev image exists
    if ! docker image inspect "$DEV_IMAGE_NAME" >/dev/null 2>&1; then
        echo "Dev image not found. Building first..."
        dev_build
    fi

    mkdir -p "$(pwd)/.gcloud"

    local SA_NAME="grant-tracker-app"
    local SA_DISPLAY_NAME="Grant Tracker App"
    local KEY_FILE="$(pwd)/.secrets/service-account-key.json"

    echo "=== Service Account Setup ==="
    echo ""

    # Get project ID
    echo "Fetching current GCP project..."
    local PROJECT_ID
    PROJECT_ID=$(docker run --rm \
        -v "$(pwd)/.gcloud":/root/.config/gcloud \
        "$DEV_IMAGE_NAME" \
        gcloud config get-value project 2>/dev/null)

    if [ -z "$PROJECT_ID" ] || [ "$PROJECT_ID" = "(unset)" ]; then
        echo "No project set. Please enter your GCP project ID:"
        read -r PROJECT_ID
        if [ -z "$PROJECT_ID" ]; then
            echo "Error: Project ID is required"
            exit 1
        fi
    fi

    echo "Using project: $PROJECT_ID"
    echo ""

    local SA_EMAIL="${SA_NAME}@${PROJECT_ID}.iam.gserviceaccount.com"

    # Check if service account already exists
    echo "Checking for existing service account..."
    if docker run --rm \
        -v "$(pwd)/.gcloud":/root/.config/gcloud \
        "$DEV_IMAGE_NAME" \
        gcloud iam service-accounts describe "$SA_EMAIL" --project="$PROJECT_ID" >/dev/null 2>&1; then
        echo "Service account already exists: $SA_EMAIL"
        echo ""
        read -p "Create a new key for the existing account? [y/N] " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Aborted."
            exit 0
        fi
    else
        # Create the service account
        echo "Creating service account: $SA_NAME"
        docker run --rm -it \
            -v "$(pwd)/.gcloud":/root/.config/gcloud \
            "$DEV_IMAGE_NAME" \
            gcloud iam service-accounts create "$SA_NAME" \
                --display-name="$SA_DISPLAY_NAME" \
                --project="$PROJECT_ID"

        if [ $? -ne 0 ]; then
            echo "Error: Failed to create service account"
            exit 1
        fi
        echo "Created: $SA_EMAIL"
    fi

    # Create the key
    echo ""
    echo "Creating service account key..."

    # Get the directory where the gt script lives (not pwd)
    local SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    local KEY_DIR="$SCRIPT_DIR/.secrets"
    KEY_FILE="$KEY_DIR/service-account-key.json"

    # Remove old key if it exists
    rm -f "$KEY_FILE"
    mkdir -p "$KEY_DIR"

    echo "Key will be saved to: $KEY_FILE"

    # Create key file - use absolute path inside container
    docker run --rm \
        -v "$SCRIPT_DIR":/workspace \
        -v "$SCRIPT_DIR/.gcloud":/root/.config/gcloud \
        -w /workspace \
        "$DEV_IMAGE_NAME" \
        sh -c "gcloud iam service-accounts keys create /workspace/.secrets/service-account-key.json --iam-account='$SA_EMAIL' --project='$PROJECT_ID'"

    local exit_code=$?

    # Debug: show what's in the container's view
    echo ""
    echo "Checking files created..."
    docker run --rm \
        -v "$SCRIPT_DIR":/workspace \
        "$DEV_IMAGE_NAME" \
        ls -la /workspace/.secrets/ 2>/dev/null || true

    if [ $exit_code -ne 0 ]; then
        echo "Error: gcloud command failed"
        exit 1
    fi

    # Verify the key was created
    if [ ! -f "$KEY_FILE" ]; then
        echo ""
        echo "Error: Key file not found at $KEY_FILE"
        echo "Checking host directory..."
        ls -la "$KEY_DIR" 2>/dev/null || echo "Directory $KEY_DIR does not exist on host"
        exit 1
    fi

    # Make sure it's readable
    chmod 644 "$KEY_FILE"

    echo ""
    echo "=== Service Account Created ==="
    echo ""
    echo "Service account email:"
    echo "  $SA_EMAIL"
    echo ""
    echo "Key file saved to:"
    echo "  .secrets/service-account-key.json"
    echo ""
    echo "=== Next Steps ==="
    echo ""
    echo "1. Share your Google Sheets spreadsheet with the service account:"
    echo "   - Open your spreadsheet"
    echo "   - Click Share"
    echo "   - Add: $SA_EMAIL"
    echo "   - Give Editor access"
    echo ""
    echo "2. Share your Grants folder with the service account:"
    echo "   - Open the folder in Google Drive"
    echo "   - Click Share"
    echo "   - Add: $SA_EMAIL"
    echo "   - Give Editor access"
    echo ""
    echo "3. Add the key to your environment file (scripts/envs/local.env):"
    echo ""
    echo "   # Option A: Reference the key file"
    echo "   GOOGLE_APPLICATION_CREDENTIALS=/workspace/.secrets/service-account-key.json"
    echo ""
    echo "   # Option B: Inline the key (for Cloud Run)"
    echo "   GOOGLE_SERVICE_ACCOUNT_KEY='\$(cat .secrets/service-account-key.json | tr -d '\\n')'"
    echo ""
    echo "=== Security Reminder ==="
    echo ""
    echo "The .secrets/ directory is in .gitignore."
    echo "NEVER commit service account keys to git."
}

gcp_run() {
    mkdir -p "$(pwd)/.gcloud"

    local tty_flags=""
    if [ -t 0 ]; then
        tty_flags="-it"
    fi
    docker run --rm $tty_flags \
        -v "$(pwd)":/workspace \
        -v "$(pwd)/.gcloud":/root/.config/gcloud \
        -w /workspace \
        "$DEV_IMAGE_NAME" \
        "$@"
}

gcp_domain() {
    local env="${1:-}"
    local domain="${2:-}"

    if [ -z "$env" ] || [ -z "$domain" ]; then
        echo "Usage: ./gt gcp domain <environment> <domain-name>"
        echo ""
        echo "Examples:"
        echo "  ./gt gcp domain staging grants-staging.example.org"
        echo "  ./gt gcp domain prod grants.example.org"
        exit 1
    fi

    # Load environment config
    if [ ! -f "scripts/envs/${env}.env" ]; then
        echo "Error: scripts/envs/${env}.env not found"
        exit 1
    fi
    source "scripts/envs/${env}.env"

    GCP_REGION="${GCP_REGION:-us-central1}"

    echo "=== Custom Domain Mapping ==="
    echo "Environment: $env"
    echo "Domain:      $domain"
    echo "Service:     $SERVICE_NAME"
    echo "Region:      $GCP_REGION"
    echo ""

    # Check if dev image exists (needed for gcloud)
    if ! docker image inspect "$DEV_IMAGE_NAME" >/dev/null 2>&1; then
        echo "Dev image not found. Building first..."
        dev_build
    fi

    mkdir -p "$(pwd)/.gcloud"

    # Set project
    docker run --rm \
        -v "$(pwd)":/workspace \
        -v "$(pwd)/.gcloud":/root/.config/gcloud \
        -w /workspace \
        "$DEV_IMAGE_NAME" \
        gcloud config set project "$GCP_PROJECT_ID"

    # Create domain mapping (requires beta track for --region flag)
    echo "Creating domain mapping..."
    docker run --rm -it \
        -v "$(pwd)":/workspace \
        -v "$(pwd)/.gcloud":/root/.config/gcloud \
        -w /workspace \
        "$DEV_IMAGE_NAME" \
        gcloud beta run domain-mappings create \
            --service "$SERVICE_NAME" \
            --domain "$domain" \
            --region "$GCP_REGION"

    echo ""
    echo "=== DNS Configuration Required ==="
    echo ""
    echo "Add these DNS records at your domain registrar:"
    echo ""

    # Get DNS records
    docker run --rm \
        -v "$(pwd)":/workspace \
        -v "$(pwd)/.gcloud":/root/.config/gcloud \
        -w /workspace \
        "$DEV_IMAGE_NAME" \
        gcloud beta run domain-mappings describe \
            --domain "$domain" \
            --region "$GCP_REGION" \
            --format="table(resourceRecords.type, resourceRecords.rrdata)"

    echo ""
    echo "=== OAuth Update Required ==="
    echo ""
    echo "Add this redirect URI to your OAuth client:"
    echo "  https://${domain}/auth/callback"
    echo ""
    echo "Go to: https://console.cloud.google.com/apis/credentials"
    echo "Edit your OAuth 2.0 Client ID and add the redirect URI."
}

gcp_deploy() {
    local env="${1:-}"
    if [ -z "$env" ]; then
        echo "Usage: ./gt gcp deploy <environment>"
        echo ""
        echo "Environments:"
        echo "  staging   Deploy to staging (grants-staging.alpha-omega.fund)"
        echo "  prod      Deploy to production (grants.alpha-omega.fund)"
        exit 1
    fi

    # Check for environment config file
    if [ ! -f "scripts/envs/${env}.env" ]; then
        echo "Error: scripts/envs/${env}.env not found"
        echo ""
        echo "To set up deployment:"
        echo "  1. cp scripts/envs/${env}.env.example scripts/envs/${env}.env"
        echo "  2. Edit scripts/envs/${env}.env with your credentials"
        echo "  3. Run: ./gt gcp auth"
        echo "  4. Run: ./gt gcp deploy ${env}"
        exit 1
    fi

    # Check if dev image exists (needed for gcloud)
    if ! docker image inspect "$DEV_IMAGE_NAME" >/dev/null 2>&1; then
        echo "Dev image not found. Building first..."
        dev_build
    fi

    # Run deploy script in dev container (has gcloud installed)
    mkdir -p "$(pwd)/.gcloud"

    docker run --rm -it \
        -v "$(pwd)":/workspace \
        -v "$(pwd)/.gcloud":/root/.config/gcloud \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -w /workspace \
        "$DEV_IMAGE_NAME" \
        /workspace/scripts/deploy.sh "$env"
}

case "${1:-}" in
    build)
        build
        ;;
    start)
        start
        ;;
    stop)
        stop
        ;;
    logs)
        logs
        ;;
    status)
        status
        ;;
    dev)
        dev
        ;;
    dev-build)
        dev_build
        ;;
    run)
        shift
        run_cmd "$@"
        ;;
    commit)
        shift
        commit "$@"
        ;;
    gcp)
        shift
        gcp "$@"
        ;;
    -h|--help|help|"")
        usage
        ;;
    *)
        echo "Unknown command: $1"
        usage
        exit 1
        ;;
esac
