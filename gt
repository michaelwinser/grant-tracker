#!/bin/bash
set -e

IMAGE_NAME="grant-tracker-dev"
CONTAINER_NAME="grant-tracker"

usage() {
    echo "Usage: ./gt <command>"
    echo ""
    echo "Commands:"
    echo "  build       Rebuild the dev container"
    echo "  start       Start the dev server (port 5173)"
    echo "  stop        Stop the running container"
    echo "  run <cmd>   Run a command in the container"
    echo "  shell       Open a shell in the container"
    echo "  logs        Show container logs"
    echo "  status      Show container status"
    echo ""
    echo "  gcp setup   Create GCP project and enable APIs"
    echo "  gcp oauth   Configure OAuth credentials"
    echo "  gcp auth    Authenticate with Google Cloud"
    echo ""
    echo "Examples:"
    echo "  ./gt build"
    echo "  ./gt start"
    echo "  ./gt run npm run build"
    echo "  ./gt gcp setup"
}

build() {
    echo "Building container..."
    docker build -t "$IMAGE_NAME" -f .devcontainer/Dockerfile .
}

start() {
    if docker ps -q -f name="$CONTAINER_NAME" | grep -q .; then
        echo "Container already running. Use './gt stop' first or './gt logs' to see output."
        exit 1
    fi

    # Remove stopped container if exists
    docker rm -f "$CONTAINER_NAME" 2>/dev/null || true

    echo "Starting dev server on http://localhost:5173"
    # Use -it only if we have a TTY
    local tty_flags=""
    if [ -t 0 ]; then
        tty_flags="-it"
    fi
    docker run --rm $tty_flags \
        --name "$CONTAINER_NAME" \
        -p 5173:5173 \
        -v "$(pwd)":/workspace \
        "$IMAGE_NAME"
}

stop() {
    if docker ps -q -f name="$CONTAINER_NAME" | grep -q .; then
        echo "Stopping container..."
        docker stop "$CONTAINER_NAME"
    else
        echo "Container not running."
    fi
}

run_cmd() {
    if [ $# -eq 0 ]; then
        echo "Error: No command specified"
        echo "Usage: ./gt run <command>"
        exit 1
    fi
    # Use -it only if we have a TTY
    local tty_flags=""
    if [ -t 0 ]; then
        tty_flags="-it"
    fi
    docker run --rm $tty_flags \
        -v "$(pwd)":/workspace \
        "$IMAGE_NAME" \
        "$@"
}

shell() {
    # Use -it only if we have a TTY
    # Starts at /workspace (project root) for access to all directories
    local tty_flags=""
    if [ -t 0 ]; then
        tty_flags="-it"
    fi
    docker run --rm $tty_flags \
        -v "$(pwd)":/workspace \
        -w /workspace \
        "$IMAGE_NAME" \
        /bin/bash
}

logs() {
    if docker ps -q -f name="$CONTAINER_NAME" | grep -q .; then
        docker logs -f "$CONTAINER_NAME"
    else
        echo "Container not running."
    fi
}

status() {
    if docker ps -q -f name="$CONTAINER_NAME" | grep -q .; then
        echo "Container is running"
        docker ps -f name="$CONTAINER_NAME" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
    else
        echo "Container is not running"
    fi
}

gcp() {
    local subcmd="${1:-}"
    case "$subcmd" in
        setup)
            gcp_run /workspace/scripts/gcp-setup.sh
            ;;
        oauth)
            gcp_run /workspace/scripts/gcp-oauth.sh
            ;;
        auth)
            shift  # remove 'auth' from args
            gcp_auth "$@"
            ;;
        "")
            echo "Usage: ./gt gcp <subcommand>"
            echo ""
            echo "Subcommands:"
            echo "  setup   Create GCP project and enable APIs"
            echo "  oauth   Configure OAuth credentials"
            echo "  auth    Authenticate with Google Cloud"
            ;;
        *)
            echo "Unknown gcp subcommand: $subcmd"
            exit 1
            ;;
    esac
}

# Handle GCP authentication - requires interactive terminal
gcp_auth() {
    if [ ! -t 0 ]; then
        echo "GCP authentication requires an interactive terminal."
        echo "Please run this command directly in your terminal:"
        echo ""
        echo "  ./gt gcp auth"
        exit 1
    fi

    # Ensure .gcloud directory exists
    mkdir -p "$(pwd)/.gcloud"

    docker run --rm -it \
        -v "$(pwd)":/workspace \
        -v "$(pwd)/.gcloud":/root/.config/gcloud \
        -w /workspace \
        "$IMAGE_NAME" \
        gcloud auth login --no-launch-browser
}

# Run a command in the container with gcloud credentials from local .gcloud directory
# Uses /workspace as workdir (not /workspace/web) for access to scripts/
gcp_run() {
    # Ensure .gcloud directory exists
    mkdir -p "$(pwd)/.gcloud"

    # Use -it only if we have a TTY
    local tty_flags=""
    if [ -t 0 ]; then
        tty_flags="-it"
    fi
    docker run --rm $tty_flags \
        -v "$(pwd)":/workspace \
        -v "$(pwd)/.gcloud":/root/.config/gcloud \
        -w /workspace \
        "$IMAGE_NAME" \
        "$@"
}

case "${1:-}" in
    build)
        build
        ;;
    start)
        start
        ;;
    stop)
        stop
        ;;
    run)
        shift
        run_cmd "$@"
        ;;
    shell)
        shell
        ;;
    logs)
        logs
        ;;
    status)
        status
        ;;
    gcp)
        shift
        gcp "$@"
        ;;
    -h|--help|help|"")
        usage
        ;;
    *)
        echo "Unknown command: $1"
        usage
        exit 1
        ;;
esac
