#!/bin/bash
set -e

IMAGE_NAME="grant-tracker"
CONTAINER_NAME="grant-tracker"
DEV_IMAGE_NAME="grant-tracker-dev"

usage() {
    echo "Usage: ./gt <command>"
    echo ""
    echo "Commands:"
    echo "  build       Build the production container"
    echo "  start       Start the app locally (port 8080)"
    echo "  stop        Stop the running container"
    echo "  logs        Show container logs"
    echo "  status      Show container status"
    echo ""
    echo "  dev         Start Vite dev server with hot reload (port 5174)"
    echo "  dev-build   Rebuild the dev container"
    echo ""
    echo "  commit <msg> [files...]  Git commit with Co-Authored-By trailer"
    echo ""
    echo "  gcp auth              Authenticate with Google Cloud"
    echo "  gcp deploy <env>      Deploy to Cloud Run (staging|prod)"
    echo "  gcp domain <env> <d>  Map custom domain to environment"
    echo ""
    echo "Examples:"
    echo "  ./gt build && ./gt start           # Local testing"
    echo "  ./gt gcp deploy staging            # Deploy to staging"
    echo "  ./gt gcp deploy prod               # Deploy to production"
    echo "  ./gt gcp domain staging grants-staging.example.com"
}

# Build production container
build() {
    echo "Building production container..."
    docker build -t "$IMAGE_NAME" -f Dockerfile .
    echo "Build complete. Run './gt start' to start the app."
}

# Start production container locally
start() {
    if docker ps -q -f name="$CONTAINER_NAME" | grep -q .; then
        echo "Container already running. Use './gt stop' first or './gt logs' to see output."
        exit 1
    fi

    # Check if image exists
    if ! docker image inspect "$IMAGE_NAME" >/dev/null 2>&1; then
        echo "Image not found. Building first..."
        build
    fi

    # Remove stopped container if exists
    docker rm -f "$CONTAINER_NAME" 2>/dev/null || true

    # Load environment from local.env (preferred) or .env (fallback)
    local env_file=""
    if [ -f scripts/envs/local.env ]; then
        env_file="--env-file scripts/envs/local.env"
    elif [ -f .env ]; then
        env_file="--env-file .env"
    else
        echo "Warning: No environment file found."
        echo "Create scripts/envs/local.env from scripts/envs/local.env.example"
    fi

    echo "Starting app on http://localhost:8080"
    docker run --rm -d \
        --name "$CONTAINER_NAME" \
        -p 8080:8080 \
        $env_file \
        "$IMAGE_NAME"

    echo "Container started. Use './gt logs' to see output."
}

stop() {
    if docker ps -q -f name="$CONTAINER_NAME" | grep -q .; then
        echo "Stopping container..."
        docker stop "$CONTAINER_NAME"
    else
        echo "Container not running."
    fi
}

logs() {
    if docker ps -q -f name="$CONTAINER_NAME" | grep -q .; then
        docker logs -f "$CONTAINER_NAME"
    else
        echo "Container not running."
    fi
}

status() {
    if docker ps -q -f name="$CONTAINER_NAME" | grep -q .; then
        echo "Container is running"
        docker ps -f name="$CONTAINER_NAME" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
    else
        echo "Container is not running"
    fi
}

# Dev mode: Vite hot reload (for frontend development)
dev() {
    local dev_container="grant-tracker-dev-server"

    if docker ps -q -f name="$dev_container" | grep -q .; then
        echo "Dev container already running. Use 'docker stop $dev_container' first."
        exit 1
    fi

    # Check if dev image exists
    if ! docker image inspect "$DEV_IMAGE_NAME" >/dev/null 2>&1; then
        echo "Dev image not found. Building first..."
        dev_build
    fi

    docker rm -f "$dev_container" 2>/dev/null || true

    echo "Starting Vite dev server on http://localhost:5174"
    local tty_flags=""
    if [ -t 0 ]; then
        tty_flags="-it"
    fi
    docker run --rm $tty_flags \
        --name "$dev_container" \
        -p 5174:5174 \
        -v "$(pwd)":/workspace \
        "$DEV_IMAGE_NAME"
}

dev_build() {
    echo "Building dev container..."
    docker build -t "$DEV_IMAGE_NAME" -f .devcontainer/Dockerfile .
}

# Git commit with automatic Co-Authored-By trailer
commit() {
    if [ $# -eq 0 ]; then
        echo "Error: No commit message specified"
        echo "Usage: ./gt commit \"message\" [files...]"
        exit 1
    fi

    local message="$1"
    shift

    # If additional args provided, stage those files
    if [ $# -gt 0 ]; then
        git add "$@"
    fi

    # Check if there are staged changes
    if ! git diff --cached --quiet; then
        git commit -m "$message" -m "Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
    else
        echo "No staged changes to commit."
        echo "Either stage files first with 'git add' or specify files: ./gt commit \"message\" file1 file2"
        exit 1
    fi
}

gcp() {
    local subcmd="${1:-}"
    case "$subcmd" in
        setup)
            gcp_run /workspace/scripts/gcp-setup.sh
            ;;
        oauth)
            gcp_run /workspace/scripts/gcp-oauth.sh
            ;;
        auth)
            shift
            gcp_auth "$@"
            ;;
        deploy)
            shift
            gcp_deploy "$@"
            ;;
        domain)
            shift
            gcp_domain "$@"
            ;;
        "")
            echo "Usage: ./gt gcp <subcommand>"
            echo ""
            echo "Subcommands:"
            echo "  auth                    Authenticate with Google Cloud"
            echo "  deploy <env>            Deploy to Cloud Run (staging|prod)"
            echo "  domain <env> <domain>   Map a custom domain to environment"
            echo ""
            echo "Examples:"
            echo "  ./gt gcp auth"
            echo "  ./gt gcp deploy staging"
            echo "  ./gt gcp deploy prod"
            echo "  ./gt gcp domain staging grants-staging.example.com"
            ;;
        *)
            echo "Unknown gcp subcommand: $subcmd"
            exit 1
            ;;
    esac
}

gcp_auth() {
    if [ ! -t 0 ]; then
        echo "GCP authentication requires an interactive terminal."
        echo "Please run this command directly in your terminal:"
        echo ""
        echo "  ./gt gcp auth"
        exit 1
    fi

    mkdir -p "$(pwd)/.gcloud"

    docker run --rm -it \
        -v "$(pwd)":/workspace \
        -v "$(pwd)/.gcloud":/root/.config/gcloud \
        -w /workspace \
        "$DEV_IMAGE_NAME" \
        gcloud auth login --no-launch-browser
}

gcp_run() {
    mkdir -p "$(pwd)/.gcloud"

    local tty_flags=""
    if [ -t 0 ]; then
        tty_flags="-it"
    fi
    docker run --rm $tty_flags \
        -v "$(pwd)":/workspace \
        -v "$(pwd)/.gcloud":/root/.config/gcloud \
        -w /workspace \
        "$DEV_IMAGE_NAME" \
        "$@"
}

gcp_domain() {
    local env="${1:-}"
    local domain="${2:-}"

    if [ -z "$env" ] || [ -z "$domain" ]; then
        echo "Usage: ./gt gcp domain <environment> <domain-name>"
        echo ""
        echo "Examples:"
        echo "  ./gt gcp domain staging grants-staging.example.org"
        echo "  ./gt gcp domain prod grants.example.org"
        exit 1
    fi

    # Load environment config
    if [ ! -f "scripts/envs/${env}.env" ]; then
        echo "Error: scripts/envs/${env}.env not found"
        exit 1
    fi
    source "scripts/envs/${env}.env"

    GCP_REGION="${GCP_REGION:-us-central1}"

    echo "=== Custom Domain Mapping ==="
    echo "Environment: $env"
    echo "Domain:      $domain"
    echo "Service:     $SERVICE_NAME"
    echo "Region:      $GCP_REGION"
    echo ""

    # Check if dev image exists (needed for gcloud)
    if ! docker image inspect "$DEV_IMAGE_NAME" >/dev/null 2>&1; then
        echo "Dev image not found. Building first..."
        dev_build
    fi

    mkdir -p "$(pwd)/.gcloud"

    # Set project
    docker run --rm \
        -v "$(pwd)":/workspace \
        -v "$(pwd)/.gcloud":/root/.config/gcloud \
        -w /workspace \
        "$DEV_IMAGE_NAME" \
        gcloud config set project "$GCP_PROJECT_ID"

    # Create domain mapping (requires beta track for --region flag)
    echo "Creating domain mapping..."
    docker run --rm -it \
        -v "$(pwd)":/workspace \
        -v "$(pwd)/.gcloud":/root/.config/gcloud \
        -w /workspace \
        "$DEV_IMAGE_NAME" \
        gcloud beta run domain-mappings create \
            --service "$SERVICE_NAME" \
            --domain "$domain" \
            --region "$GCP_REGION"

    echo ""
    echo "=== DNS Configuration Required ==="
    echo ""
    echo "Add these DNS records at your domain registrar:"
    echo ""

    # Get DNS records
    docker run --rm \
        -v "$(pwd)":/workspace \
        -v "$(pwd)/.gcloud":/root/.config/gcloud \
        -w /workspace \
        "$DEV_IMAGE_NAME" \
        gcloud beta run domain-mappings describe \
            --domain "$domain" \
            --region "$GCP_REGION" \
            --format="table(resourceRecords.type, resourceRecords.rrdata)"

    echo ""
    echo "=== OAuth Update Required ==="
    echo ""
    echo "Add this redirect URI to your OAuth client:"
    echo "  https://${domain}/auth/callback"
    echo ""
    echo "Go to: https://console.cloud.google.com/apis/credentials"
    echo "Edit your OAuth 2.0 Client ID and add the redirect URI."
}

gcp_deploy() {
    local env="${1:-}"
    if [ -z "$env" ]; then
        echo "Usage: ./gt gcp deploy <environment>"
        echo ""
        echo "Environments:"
        echo "  staging   Deploy to staging (grants-staging.alpha-omega.fund)"
        echo "  prod      Deploy to production (grants.alpha-omega.fund)"
        exit 1
    fi

    # Check for environment config file
    if [ ! -f "scripts/envs/${env}.env" ]; then
        echo "Error: scripts/envs/${env}.env not found"
        echo ""
        echo "To set up deployment:"
        echo "  1. cp scripts/envs/${env}.env.example scripts/envs/${env}.env"
        echo "  2. Edit scripts/envs/${env}.env with your credentials"
        echo "  3. Run: ./gt gcp auth"
        echo "  4. Run: ./gt gcp deploy ${env}"
        exit 1
    fi

    # Check if dev image exists (needed for gcloud)
    if ! docker image inspect "$DEV_IMAGE_NAME" >/dev/null 2>&1; then
        echo "Dev image not found. Building first..."
        dev_build
    fi

    # Run deploy script in dev container (has gcloud installed)
    mkdir -p "$(pwd)/.gcloud"

    docker run --rm -it \
        -v "$(pwd)":/workspace \
        -v "$(pwd)/.gcloud":/root/.config/gcloud \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -w /workspace \
        "$DEV_IMAGE_NAME" \
        /workspace/scripts/deploy.sh "$env"
}

case "${1:-}" in
    build)
        build
        ;;
    start)
        start
        ;;
    stop)
        stop
        ;;
    logs)
        logs
        ;;
    status)
        status
        ;;
    dev)
        dev
        ;;
    dev-build)
        dev_build
        ;;
    commit)
        shift
        commit "$@"
        ;;
    gcp)
        shift
        gcp "$@"
        ;;
    -h|--help|help|"")
        usage
        ;;
    *)
        echo "Unknown command: $1"
        usage
        exit 1
        ;;
esac
